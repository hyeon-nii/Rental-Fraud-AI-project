import sys
import os

sys.path.append(os.path.join(os.path.dirname(__file__), 'classifier'))
sys.path.append(os.path.join(os.path.dirname(__file__), 'rag_engine'))

from classifier.classifier_logic import start_diagnosis_flow, analyze_user_query
from rag_engine.run_chain import get_rag_response


def main():
    """AI ë‹´ë‹¹ 2 + AI ë‹´ë‹¹ 1 í†µí•© ì‹¤í–‰ - ëŒ€í™”í˜• ì±—ë´‡"""
    
    print("="*70)
    print("ğŸ  ì „ì„¸ì‚¬ê¸° í”¼í•´ì ì§€ì› í†µí•© ìƒë‹´ ì‹œìŠ¤í…œ")
    print("="*70 + "\n")
    
    # ========================================
    # 1ë‹¨ê³„: AI ë‹´ë‹¹ 2 - ìš”ê±´ íŒë³„
    # ========================================
    user_situation = start_diagnosis_flow()
    print(f"\nğŸ“Š [1ë‹¨ê³„ ì™„ë£Œ] ì§„ë‹¨ ê²°ê³¼: '{user_situation}'")
    
    # ì œì™¸ ëŒ€ìƒì´ë‚˜ ë¯¸ì¶©ì¡±ì´ë©´ ì¢…ë£Œ
    if user_situation in ["ì§€ì› ì œì™¸ ëŒ€ìƒ", "ì§€ì› ìš”ê±´ ë¯¸ì¶©ì¡±"]:
        print("\nâš ï¸ ì¶”ê°€ ìƒë‹´ì´ í•„ìš”í•©ë‹ˆë‹¤. ê°€ê¹Œìš´ ì§€ì›ì„¼í„°ì— ë¬¸ì˜í•´ì£¼ì„¸ìš”.")
        return
    
    # ========================================
    # 2ë‹¨ê³„: ìì¹˜êµ¬ ì •ë³´ ìˆ˜ì§‘
    # ========================================
    district = input("\nğŸ“ [ì¶”ê°€ ì •ë³´] ê±°ì£¼í•˜ì‹œëŠ” ìì¹˜êµ¬ë¥¼ ì•Œë ¤ì£¼ì„¸ìš” (ì˜ˆ: ì¢…ë¡œêµ¬, ê°•ë‚¨êµ¬): ").strip()
    
    # ========================================
    # 3ë‹¨ê³„: ì²« ë²ˆì§¸ ì§ˆë¬¸ ë°›ê¸°
    # ========================================
    print("\nğŸ’¬ [2ë‹¨ê³„ ì§„í–‰] ì´ì œë¶€í„° ê¶ê¸ˆí•˜ì‹  ì ì„ ììœ ë¡­ê²Œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”.")
    print("ğŸ’¡ ì–¸ì œë“ ì§€ 'ì¢…ë£Œ', 'exit', 'ê·¸ë§Œ' ì„ ì…ë ¥í•˜ì‹œë©´ ìƒë‹´ì´ ì¢…ë£Œë©ë‹ˆë‹¤.\n")
    
    user_query = input("ì§ˆë¬¸: ").strip()
    
    # ìœ„ê¸° í‚¤ì›Œë“œ ì²´í¬
    query_analysis = analyze_user_query(user_query)
    if query_analysis["status"] == "crisis":
        print("\nğŸš¨ [ê¸´ê¸‰ ìƒí™© ê°ì§€]")
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print("ğŸ†˜ ìì‚´ì˜ˆë°© ìƒë‹´ì „í™”: 1393 (24ì‹œê°„ ë¬´ë£Œ)")
        print("ğŸ†˜ ì •ì‹ ê±´ê°• ìœ„ê¸°ìƒë‹´: 1577-0199")
        print("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”")
        print("í˜¼ì ê°ë‹¹í•˜ì§€ ë§ˆì‹œê³  ì „ë¬¸ê°€ì™€ ìƒë‹´í•˜ì‹œê¸¸ ê°„ê³¡íˆ ë¶€íƒë“œë¦½ë‹ˆë‹¤.")
        return
    
    # ========================================
    # 4ë‹¨ê³„: ëŒ€í™” ë£¨í”„ ì‹œì‘ (ë¬´í•œ ë°˜ë³µ)
    # ========================================
    conversation_count = 0
    
    while True:
        conversation_count += 1
        
        # ì¢…ë£Œ ëª…ë ¹ì–´ ì²´í¬
        if user_query.lower() in ['ì¢…ë£Œ', 'exit', 'ê·¸ë§Œ', 'quit', 'q', 'ë']:
            print("\n" + "="*70)
            print("âœ… ìƒë‹´ì„ ì¢…ë£Œí•©ë‹ˆë‹¤. í˜ë‚´ì„¸ìš”! ğŸ™")
            print(f"ì´ {conversation_count}ë²ˆì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ë“œë ¸ìŠµë‹ˆë‹¤.")
            print("="*70)
            break
        
        # ë¹ˆ ì…ë ¥ ì²˜ë¦¬
        if not user_query.strip():
            user_query = input("\nğŸ’¬ ë‹¤ì‹œ ì§ˆë¬¸í•´ì£¼ì„¸ìš”: ").strip()
            continue
        
        # AI ë‹´ë‹¹ 1 - RAG ë‹µë³€ ìƒì„±
        print("\nğŸ’­ ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...\n")
        
        # ì²« ì§ˆë¬¸ì—ë§Œ ìì¹˜êµ¬ ì •ë³´ í¬í•¨
        if conversation_count == 1:
            response = get_rag_response(user_situation, user_query, district)
        else:
            response = get_rag_response(user_situation, user_query)
        
        # ë‹µë³€ ì¶œë ¥
        print("="*70)
        print("ğŸ“ ë‹µë³€")
        print("="*70 + "\n")
        print(response)
        print("\n" + "="*70 + "\n")
        
        # ë‹¤ìŒ ì§ˆë¬¸ ë°›ê¸°
        print("ğŸ’¬ ì¶”ê°€ë¡œ ê¶ê¸ˆí•˜ì‹  ì ì´ ìˆìœ¼ì‹ ê°€ìš”?")
        print("   (ì¢…ë£Œí•˜ë ¤ë©´ 'ì¢…ë£Œ' ì…ë ¥)")
        user_query = input("\nì§ˆë¬¸: ").strip()


if __name__ == "__main__":
    main()
