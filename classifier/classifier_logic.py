from langchain_core.prompts import ChatPromptTemplate

# ==============================================================================
# 0. ì„¤ì • ë° ìƒìˆ˜
# ==============================================================================
CRISIS_KEYWORDS = ["ì£½ê³  ì‹¶", "ìì‚´", "ê·¹ë‹¨ì ", "ëë‚´ê³  ì‹¶", "ì‚´ê¸° ì‹«"]

SYSTEM_PROMPT_PATH = "classifier/system_prompt.txt"  # system prompt íŒŒì¼ ê²½ë¡œ

# ==============================================================================
# 1. ê°ì • ë° ìœ„ê¸° ê°ì§€
# ==============================================================================
def analyze_user_query(text: str) -> dict:
    """ì‚¬ìš©ìì˜ ì…ë ¥ì—ì„œ ìœ„ê¸° ìƒí™©ì„ ê°ì§€í•©ë‹ˆë‹¤."""
    processed_text = text.replace(" ", "")
    for keyword in CRISIS_KEYWORDS:
        if keyword in processed_text:
            return {"status": "crisis", "keyword": keyword}
    return {"status": "normal"}


# ==============================================================================
# 2. ì´ˆê¸° ìƒë‹´ ë‹¨ê³„ (ê³µê° + ìœ„ê¸° ë¶„ê¸°)
# ==============================================================================
def start_initial_conversation() -> dict:
    """ì´ˆê¸° ìƒë‹´: ì¸ì‚¬ â†’ ìœ„ê¸° ê°ì§€ â†’ ê³µê° ë˜ëŠ” ìƒë‹´ ì•ˆë‚´"""
    print("AI ì²­ì›” ğŸŒ™: ì•ˆë…•í•˜ì„¸ìš”, ì²­ì›”ì…ë‹ˆë‹¤.")
    print("ì°¾ì•„ì£¼ì‹  ë¶„ê»˜ì„œëŠ” ì–´ë–¤ ìƒí™©ì´ì‹ ê°€ìš”?\n")

    user_first = input("ì‚¬ìš©ì: ").strip()
    emotion = analyze_user_query(user_first)

    # ğŸš¨ ìœ„ê¸° ìƒí™© ê°ì§€
    if emotion["status"] == "crisis":
        print("""
AI ì²­ì›” ğŸŒ™:
ë§ì”€í•´ì£¼ì…”ì„œ ê°ì‚¬í•´ìš”.

ì§€ê¸ˆ ë‹¹ì¥ í•  ì¼ì€ ì „ì„¸ì‚¬ê¸° ë¬¸ì œê°€ ì•„ë‹ˆë¼ ë‹˜ì˜ ë§ˆìŒì„ ëŒë³´ëŠ” ê±°ì˜ˆìš”.

â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸš¨ ì§€ê¸ˆ ì¦‰ì‹œ ì „í™”í•˜ì„¸ìš”
ìì‚´ì˜ˆë°©ìƒë‹´ì „í™” â˜ï¸ 1393
â€¢ 24ì‹œê°„ ìš´ì˜
â€¢ ë¬´ë£Œ
â€¢ ìµëª… ê°€ëŠ¥
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

ì „í™”í•˜ì‹œê¸° ì–´ë ¤ìš°ì‹œë©´
ì¹´ì¹´ì˜¤í†¡ 'ë§ˆìŒí„°' ì±„íŒ…ìƒë‹´ (24ì‹œê°„ ìš´ì˜)

ì „ì„¸ì‚¬ê¸° ë¬¸ì œëŠ” ë‹˜ì˜ ë§ˆìŒì´ ì•ˆì •ëœ ë‹¤ìŒì— ì²œì²œíˆ í•´ê²°í•˜ë©´ ë¼ìš”.
ì œê°€ ì—¬ê¸° ìˆì„ê²Œìš”. ì–¸ì œë“  ë‹¤ì‹œ ì˜¤ì„¸ìš”.
        """)
        return {"status": "crisis"}

    # ğŸ˜Š ì •ìƒ ìƒí™©ì¼ ê²½ìš° ê³µê° ë©˜íŠ¸ í›„ ì§„ë‹¨ ë‹¨ê³„ë¡œ ì§„ì…
    print("""
AI ì²­ì›” ğŸŒ™:
ì „ì„¸ ì‚¬ê¸°ë¥¼ ë‹¹í•˜ì…¨êµ°ìš”. ë§ì´ ë†€ë¼ì…¨ê² ì–´ìš”.
ì¼ë‹¨ ìˆ¨ í•œë²ˆ ê¹Šê²Œ ì‰¬ì‹œê³ , ì²œì²œíˆ ë§ì”€í•´ì£¼ì„¸ìš”.
ëª‡ ê°€ì§€ë§Œ ì—¬ì­¤ë³¼ê²Œìš”.
    """)
    return {"status": "normal", "text": user_first}


# ==============================================================================
# 3. í”¼í•´ì ìš”ê±´ ì§„ë‹¨
# ==============================================================================
def determine_victim_status(user_data: dict) -> str:
    """[ê³µì‹ ê¸°ì¤€] í”¼í•´ì ì§€ì› ë“±ê¸‰ì„ íŒë³„"""
    req1 = user_data.get("ìš”ê±´1_ëŒ€í•­ë ¥", False)
    req2 = user_data.get("ìš”ê±´2_ë³´ì¦ê¸ˆì•¡", False)
    req3 = user_data.get("ìš”ê±´3_ë‹¤ìˆ˜í”¼í•´", False)
    req4 = user_data.get("ìš”ê±´4_ì‚¬ê¸°ì˜ë„", False)
    exc1 = user_data.get("ì œì™¸_ë³´ì¦ë³´í—˜", False)
    exc2 = user_data.get("ì œì™¸_ìµœìš°ì„ ë³€ì œ", False)
    exc3 = user_data.get("ì œì™¸_ìë ¥íšŒìˆ˜", False)

    if exc1 or exc2 or exc3:
        return "ì§€ì› ì œì™¸ ëŒ€ìƒ"
    if req1 and req2 and req3 and req4:
        return "í”¼í•´ì ê²°ì • (ëª¨ë“  ì§€ì› ê°€ëŠ¥)"
    if not req1 and req2 and req4:
        return "í”¼í•´ì ê²°ì • (ê¸ˆìœµì§€ì› ë° ê¸´ê¸‰ë³µì§€ ê°€ëŠ¥)"
    if req1 and not req2 and req3 and req4:
        return "í”¼í•´ì ê²°ì • (ì¡°ì„¸ì±„ê¶Œ ì•ˆë¶„ ì§€ì› ê°€ëŠ¥)"
    return "ì§€ì› ìš”ê±´ ë¯¸ì¶©ì¡±"


def start_diagnosis_flow() -> str:
    """í”¼í•´ì ì§€ì› ìš”ê±´ ì§„ë‹¨ ì ˆì°¨"""
    questions = [
        ("ì£¼íƒ ì¸ë„, ì „ì…ì‹ ê³ , í™•ì •ì¼ìë¥¼ ëª¨ë‘ ê°–ì¶”ì…¨ë‚˜ìš”? (ì„ì°¨ê¶Œ ë“±ê¸° í¬í•¨)", "ìš”ê±´1_ëŒ€í•­ë ¥"),
        ("ì„ëŒ€ì°¨ ë³´ì¦ê¸ˆì´ 5ì–µ ì› ì´í•˜ì¸ê°€ìš”?", "ìš”ê±´2_ë³´ì¦ê¸ˆì•¡"),
        ("ì§‘ì£¼ì¸ì˜ íŒŒì‚°, ê²½ë§¤ ë“±ìœ¼ë¡œ 2ì¸ ì´ìƒ ì„ì°¨ì¸ì—ê²Œ í”¼í•´ê°€ ë°œìƒí–ˆë‚˜ìš”?", "ìš”ê±´3_ë‹¤ìˆ˜í”¼í•´"),
        ("ì„ëŒ€ì¸ì´ ë³´ì¦ê¸ˆì„ ëŒë ¤ì¤„ ì˜ì‚¬ë‚˜ ëŠ¥ë ¥ì´ ì—†ì—ˆë‹¤ê³  ì˜ì‹¬ë˜ë‚˜ìš”?", "ìš”ê±´4_ì‚¬ê¸°ì˜ë„"),
        ("ì „ì„¸ë³´ì¦ê¸ˆ ë°˜í™˜ ë³´ì¦ë³´í—˜ì— ê°€ì…ë˜ì–´ ìˆë‚˜ìš”?", "ì œì™¸_ë³´ì¦ë³´í—˜"),
        ("ì†Œì•¡ì„ì°¨ì¸ ìµœìš°ì„ ë³€ì œ ì œë„ë¡œ ë³´ì¦ê¸ˆ 'ì „ì•¡'ì„ ëŒë ¤ë°›ì„ ìˆ˜ ìˆë‚˜ìš”?", "ì œì™¸_ìµœìš°ì„ ë³€ì œ"),
        ("ëŒ€í•­ë ¥(ê²½ë§¤ ì‹ ì²­ ë“±)ì„ í†µí•´ ë³´ì¦ê¸ˆ 'ì „ì•¡'ì„ ì§ì ‘ íšŒìˆ˜í•  ìˆ˜ ìˆë‚˜ìš”?", "ì œì™¸_ìë ¥íšŒìˆ˜")
    ]

    user_data = {}
    print("AI ì²­ì›” ğŸŒ™: ì•„ë˜ ì§ˆë¬¸ì— ì˜ˆ/ì•„ë‹ˆì˜¤ë¡œ ë‹µë³€í•´ì£¼ì„¸ìš”.\n")

    def ask(question, key):
        while True:
            answer = input(f"â“ {question} (ì˜ˆ/ì•„ë‹ˆì˜¤): ").strip().lower()
            if answer in ["ì˜ˆ", "y", "yes"]:
                user_data[key] = True
                break
            elif answer in ["ì•„ë‹ˆì˜¤", "ì•„ë‹ˆìš”", "n", "no"]:
                user_data[key] = False
                break
            else:
                print("âš ï¸ 'ì˜ˆ' ë˜ëŠ” 'ì•„ë‹ˆì˜¤'ë¡œë§Œ ë‹µë³€í•´ì£¼ì„¸ìš”.")

    for q_text, q_key in questions:
        ask(q_text, q_key)

    result = determine_victim_status(user_data)
    print(f"\nğŸ“Š [ì§„ë‹¨ ê²°ê³¼] ì²­ì›” íŒë‹¨: {result}")
    return result


# ==============================================================================
# 4. í”„ë¡¬í”„íŠ¸ ìƒì„±
# ==============================================================================
def create_prompt(user_situation: str, user_query: str):
    """LangChain ChatPromptTemplate ê¸°ë°˜ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
    with open(SYSTEM_PROMPT_PATH, "r", encoding="utf-8") as f:
        system_text = f.read()

    prompt = ChatPromptTemplate.from_messages([
        ("system", system_text),
        ("human", "{user_query}")
    ])

    formatted = prompt.format_messages(
        user_situation=user_situation,
        user_query=user_query
    )
    return formatted


# ==============================================================================
# 5. í†µí•© ì‹¤í–‰ (AI-2 ì „ì²´ íë¦„)
# ==============================================================================
def run_ai2_pipeline():
    """ì´ˆê¸° ìƒë‹´ â†’ ìœ„ê¸° ê°ì§€ â†’ ì§„ë‹¨ â†’ í”„ë¡¬í”„íŠ¸ ìƒì„±"""
    # ì´ˆê¸° ìƒë‹´
    init_result = start_initial_conversation()
    if init_result["status"] == "crisis":
        return None  # ìœ„ê¸° ì¢…ë£Œ

    # ì§„ë‹¨ ë‹¨ê³„
    user_situation = start_diagnosis_flow()

    # ì‚¬ìš©ì ë§ˆì§€ë§‰ ì§ˆë¬¸
    user_query = input("\nì²­ì›” ğŸŒ™: ë§ˆì§€ë§‰ìœ¼ë¡œ, ê°€ì¥ ê¶ê¸ˆí•˜ì‹  ì ì„ ë§ì”€í•´ì£¼ì„¸ìš”.\nì‚¬ìš©ì: ")

    # í”„ë¡¬í”„íŠ¸ ìƒì„±
    final_prompt = create_prompt(user_situation, user_query)

    print("\n--------------------------------------")
    print("ğŸ“¤ [AI-1 ì „ë‹¬ìš© í”„ë¡¬í”„íŠ¸]")
    for msg in final_prompt:
        print(f"**{msg.type.upper()}:**\n{msg.content}\n")
    print("--------------------------------------")

    return final_prompt


# ==============================================================================
# 6. ì‹¤í–‰
# ==============================================================================
if __name__ == "__main__":
    run_ai2_pipeline()
